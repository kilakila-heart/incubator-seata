#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Rerun build

on:
  workflow_run:
    workflows: ["build"]
    types:
      - completed

permissions:
  actions: write

jobs:
  rerun:
    if: github.event.workflow_run.conclusion == 'failure' && fromJSON(github.event.workflow_run.run_attempt) < 2
    runs-on: ubuntu-latest
    steps:
      - name: Check if failure is due to spotless
        id: check-spotless
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LOGS=$(gh run view ${{ github.event.workflow_run.id }} --log)
          if echo "$LOGS" | grep -i "Run 'mvn spotless:apply' to fix these violations."; then
            echo "spotless_failure=true" >> $GITHUB_OUTPUT
            echo "Build failed due to specific spotless instruction. Will not retry."
          else
            echo "spotless_failure=false" >> $GITHUB_OUTPUT
            echo "Build failed for other reasons or a different spotless issue. Will retry."
          fi

      - name: rerun ${{ github.event.workflow_run.id }}
        if: steps.check-spotless.outputs.spotless_failure != 'true'
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run watch ${{ github.event.workflow_run.id }} > /dev/null 2>&1
          gh run rerun ${{ github.event.workflow_run.id }} --failed